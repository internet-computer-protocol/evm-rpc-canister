# IC ðŸ”— ETH (Canister API)

## Terminology

* `service`: A Web2 service such as [Infura](https://www.infura.io/), [Gateway.fm](https://gateway.fm/), or [CloudFlare](https://www.cloudflare.com/en-gb/web3/) that offers access to the Ethereum JSON-RPC API through HTTP. Note that also other EVM-compatible chains may be covered by such a JSON-RPC API.
* `network`: An EVM blockchain such as the Ethereum mainnet or Sepolia testnet.
* `chain id`: An EVM network identifier (e.g. `0x1` for the Ethereum mainnet, `0xaa36a7` for the Sepolia testnet). 
* `provider`: A provider is registered in the canister and allows for connecting to a specific JSON-RPC service. Each chain id for a particular service requires a different provider and typically requires a different API key. Multiple providers can be registered for a service / chain id combination.

View this [reference site](https://chainlist.org/) for a list of available networks and services. 

## Methods

### `register_provider`

Register a new provider for a Web2-based service.

```candid
type RegisterProvider = record {
    chain_id: nat64;
    base_url: text;
    credential_path: text;
    cycles_per_call: nat64;
    cycles_per_message_byte: nat64;
};

register_provider: (RegisterProvider) -> ();
```

The `RegisterProvider` record defines the details about the service to register, including the API key for the service.
* `chain_id`: The id of the Ethereum chain this provider allows to connect to. The ids refer to the chain ids as defined for EVM-compatible blockchains, see, e.g., [ChainList](https://chainlist.org/?testnets=true).
* `base_url`: The URLs of the Web2 service provider that is used by the canister when using this provider.
* `credential_path`: A path containing API key for authorizing requests to this service provider. This part of the path is private to the entity registering it and the canister. It is not exposed in the response of the `get_providers` method. The URL used to access the service is constructed by concatenating the `base_url` and the `credential_path` (without a seperator), e.g., "https://cloudflare-eth.com" and "/my-api-key".
* `cycles_per_call`: Cycles charged per call by the canister in addition to the base charges when using this provider.
* `cycles_per_message_byte`: Cycles charged per payload byte by the canister in addition to the base charges when using this provider.

The cycles charged can, for example, be used by the entity providing the API key to amortize the API key costs in the case of commercial API keys. A provider record can be removed by its owner principal or a pricipal with administrative permissions.

### `get_providers`

Returns a list of currently registered `RegisteredProvider` entries of the canister.

```candid
type RegisteredProvider = record {
    provider_id: nat64;
    owner: principal;
    chain_id: nat64;
    base_url: text;
    cycles_per_call: nat64;
    cycles_per_message_byte: nat64;
};

get_providers: () -> (vec RegisteredProvider) query;
```

`vec RegisteredProvider` is a list of providers, each of which represents one provider that has been registered with the canister and corresponds to a registration of an API key for a specific external API service and chain id. A provider entry also contains the cycles price for using this provider, in addition to what is charged for the canister services.

* `provider_id`: A unique id per registered provider generated by the canister during provider registration.
* `owner`: The principal that has registered the provider and is authorized to unregister it.
* `chain_id`: See `RegisterProvider`.
* `service _url`: See `RegisterProvider`.
* `cycles_per_call`: See `RegisterProvider`.
* `cycles_per_message_byte`: See `RegisterProvider`.

Clients of this canister need to select a provider that matches w.r.t. the `chain_id` the network they intend to connect to. If multiple providers are available for a given `chain_id`, the per-message or per-byte price or the entity behind the provider (this can be inferred from the `base_url`) may be factors to choose a suitable provider.

### `request`

Make a request to a Web2 Ethereum node using the caller's URL to an openly available JSON-RPC service, or the caller's URL including an API key for an access-protected API provider. No registered API key of the canister is used in this scenario.

    request: (service_url: text, json_rpc_payload: text, max_response_bytes: nat64) -> (EthRpcResult);

* `service_url`: The URL of the service, including any API key if required for access-protected services.
* `json_rpc_payload`: The payload for the JSON-RPC request. View examples in the [Ethereum documentation](https://ethereum.org/en/developers/docs/apis/json-rpc/).
* `max_response_bytes`: The expected maximum size of the response of the Web2 API server. This parameter determines the network response size that is charged for. Not specifying it or it being larger than required may lead to substantial extra cycles cost for the HTTPS outcalls mechanism as its (large) default value is used and charged for.
* `EthRpcResult`: The response comprises the JSON-encoded result or error, see the corresponding type.

### `provider_request`

Make a request to a Web2 Ethereum node using a registered provider for a JSON-RPC service. There is no need for the client to have any established relationship with the API service.

    provider_request: (provider_id: nat64, json_rpc_payload: text, max_response_bytes: nat64) -> (EthRpcResult);

* `provider_id`: The id of the registered provider to be used for this call. This uniquely identifies a provider registered with the canister.
* `json_rpc_payload`: See `request`.
* `max_response_bytes`: See `request`.
* `EthRpcResult`: See `request`.

### `request_cost`

Calculate the cost of sending a request with the given input arguments.

    request_cost: (service_url: text, json_rpc_payload: text, max_response_bytes: nat64) -> (nat) query;

* `service_url`: The URL of the service, including any API key if required for access-protected services.
* `json_rpc_payload`: See `request`.
* `max_response_bytes`: See `request`.

### `provider_request_cost`

Calculate the cost of sending a request with the given input arguments.

    provider_request_cost: (provider_id: nat64, json_rpc_payload: text, max_response_bytes: nat64) -> (nat) query;

* `provider_id`: The id of the registered provider to be used for this call. This uniquely identifies a provider registered with the canister.
* `json_rpc_payload`: See `request_cost`.
* `max_response_bytes`: See `request_cost`.

### `unregister_provider`

Unregister a provider from the canister. Only the owner of the provider or an admin principal is authorized to perform this action.

```candid
unregister_provider: (provider_id: nat64) -> ();
```

The `provider_id` for the provider to be unregistered is the only parameter required.

### `authorize`

Used for authorizing a principal for certain classes of actions as defined through `Auth`.

```candid
authorize : (principal, Auth) -> ();

type Auth = variant { Rpc; RegisterProvider; Admin };
```

The `Auth` variant defines the following cases:
* `Rpc`: Governs access control to the RPC methods.
* `RegisterProvider`: Governs access control to the `register_provider` method.
* `Admin`: Governs admin access to any configuration. This should be callable only by a DAO and not a principal controlled by a single person in case a decentralized deployment is envisioned.

The `authorize` method takes two parameters: The `principal` is the principal to be authorized and `Auth` defines the scope of the authorization as defined through `Auth`.
