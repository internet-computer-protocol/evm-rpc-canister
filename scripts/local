#!/usr/bin/env bash
# Redeploy the canister and set up permissions in your local environment.

CANISTER_ID=evm_rpc
PRINCIPAL=$(dfx identity get-principal)


dfx deploy evm_rpc --argument "(record {nodesInSubnet = 13})" --mode reinstall -y
dfx deploy evm_rpc_fiduciary --argument "(record {nodesInSubnet = 26})" --mode reinstall -y

dfx canister call $CANISTER_ID authorize "(principal \"$PRINCIPAL\", variant { RegisterProvider })"

dfx canister call $CANISTER_ID registerProvider '(record {hostname = "cloudflare-eth.com"; credentialPath = "/v1/mainnet"; chainId = 1; cyclesPerCall = 1000; cyclesPerMessageByte = 100})'

dfx canister call $CANISTER_ID requestCost '(variant {Chain=1}, "{ \"jsonrpc\": \"2.0\", \"method\": \"eth_getBlockByNumber\", \"params\": [\"0x2244\", true], \"id\": 1 }", 1000)'
dfx canister call $CANISTER_ID request '(variant {Chain=1}, "{ \"jsonrpc\": \"2.0\", \"method\": \"eth_getBlockByNumber\", \"params\": [\"0x2244\", true], \"id\": 1 }", 1000)'

dfx canister call $CANISTER_ID requestCost '(variant {Provider=0}, "{ \"jsonrpc\": \"2.0\", \"method\": \"eth_getBlockByNumber\", \"params\": [\"0x2244\", true], \"id\": 1 }", 1000)'
dfx canister call $CANISTER_ID request '(variant {Provider=0}, "{ \"jsonrpc\": \"2.0\", \"method\": \"eth_getBlockByNumber\", \"params\": [\"0x2244\", true], \"id\": 1 }", 1000)'
